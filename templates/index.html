<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>StudySpark</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(120deg, #f9fafb, #eef2ff);
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
    }
    .navbar {
      background-color: white;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .navbar-brand { font-weight: 700; color: #4338ca !important; }
    .nav-link {
      font-weight: 500;
      color: #4b5563 !important;
      transition: all 0.2s;
    }
    .nav-link.active {
      color: #4338ca !important;
      border-bottom: 3px solid #4338ca;
    }

    .container { max-width: 800px; margin-top: 60px; }
    .card {
      border-radius: 16px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
      padding: 30px;
      background: white;
      transition: all 0.3s ease;
    }

    .btn-primary { background: #4338ca; border: none; border-radius: 8px; padding: 10px 18px; font-weight: 500; }
    .btn-primary:hover { background: #312e81; transform: scale(1.03); }
    .btn-success { background: #16a34a; border: none; border-radius: 8px; padding: 10px 18px; font-weight: 500; }
    .btn-success:hover { background: #15803d; transform: scale(1.03); }

    textarea { border-radius: 10px; padding: 15px; font-size: 15px; width: 100%; height: 200px; resize: vertical; }

    .stream-output {
      font-size: 16px;
      white-space: pre-wrap;
      background: #f9fafb;
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      min-height: 100px;
      border: 1px solid #e5e7eb;
      line-height: 1.5;
    }

    .spinner {
      display: none;
      text-align: center;
      font-size: 18px;
      margin-top: 15px;
      color: #4338ca;
    }

    footer { text-align: center; color: #6b7280; font-size: 14px; margin-top: 50px; padding-bottom: 30px; }

    /* Tip & History styling */
    #tip-card p { font-size: 15px; line-height: 1.5; }
    #history-card ul { max-height: 200px; overflow-y: auto; }
  </style>

  <!-- MathJax -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async
   src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg sticky-top">
    <div class="container-fluid px-4">
      <a class="navbar-brand" href="#">üìò StudySpark</a>
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link active" href="#" data-section="summarize">Summarize</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-section="solve">Solve</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-section="custom">Custom Prompt</a></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <!-- Summarize Section -->
    <div id="summarize-section" class="card section">
      <h3 class="mb-3 text-center text-primary">‚ú® Summarize</h3>
      <form class="upload-form" data-action="summarize" enctype="multipart/form-data">
        <label class="form-label fw-semibold">Upload your document</label>
        <input type="file" class="form-control mb-3" accept=".pdf,.txt,.jpeg,.jpg,.png" required>
        <button type="submit" class="btn btn-primary w-100">Summarize File</button>
      </form>
      <div id="summarize-spinner" class="spinner">‚ö° Processing...</div>
      <div id="summarize-output" class="stream-output"></div>
    </div>

    <!-- Solve Section -->
    <div id="solve-section" class="card section" style="display:none;">
      <h3 class="mb-3 text-center text-success">üß© Solve & Explain</h3>
      <form class="upload-form" data-action="solve" enctype="multipart/form-data">
        <label class="form-label fw-semibold">Upload a problem sheet or image</label>
        <input type="file" class="form-control mb-3" accept=".pdf,.txt,.jpeg,.jpg,.png" required>
        <button type="submit" class="btn btn-success w-100">Solve & Explain</button>
      </form>
      <div id="solve-spinner" class="spinner">‚ö° Processing...</div>
      <div id="solve-output" class="stream-output"></div>
    </div>

    <!-- Custom Prompt Section -->
    <div id="custom-section" class="card section" style="display:none;">
      <h3 class="mb-3 text-center text-secondary">üß† Custom Prompt</h3>
      <textarea id="custom-prompt" placeholder="Type your own question or prompt here..."></textarea>
      <div class="mt-3 d-flex gap-2">
        <input type="file" id="custom-file" class="form-control" accept=".pdf,.txt,.jpeg,.jpg,.png">
        <button id="custom-btn" class="btn btn-primary w-25">Run</button>
      </div>
      <div id="custom-spinner" class="spinner">‚ö° Processing...</div>
      <div id="custom-output" class="stream-output"></div>
    </div>
  </div>

  <!-- Tip of the Day & Recent History -->
  <div class="container mt-5">
    <div class="row g-4">
      <!-- Tip of the Day -->
      <div class="col-md-6">
        <div class="card p-4" id="tip-card">
          <h5 class="text-primary">üí° Tip of the Day</h5>
          <p id="study-tip" class="text-muted mt-2">{{ tip_of_the_day }}</p>
        </div>
      </div>

      <!-- Recent History -->
      <div class="col-md-6">
        <div class="card p-4" id="history-card">
          <h5 class="text-success">üïí Recent History</h5>
          <ul id="history-list" class="list-group list-group-flush small">
            {% for entry in recent_history %}
              <li class="list-group-item">
                <strong>{{ entry.action }}</strong> - {{ entry.file }}
                <span class="text-muted">({{ entry.time }})</span>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>

  <footer>Made with ‚ö° by StudySpark</footer>

  <script>
    // --- Section Switching ---
    const navLinks = document.querySelectorAll(".nav-link");
    const sections = document.querySelectorAll(".section");

    navLinks.forEach(link => {
      link.addEventListener("click", e => {
        e.preventDefault();
        navLinks.forEach(l => l.classList.remove("active"));
        link.classList.add("active");
        const target = link.dataset.section;
        sections.forEach(sec => sec.style.display = "none");
        document.getElementById(`${target}-section`).style.display = "block";
      });
    });

    // --- File Upload + Streaming Handler ---
    document.querySelectorAll(".upload-form").forEach(form => {
      form.addEventListener("submit", async e => {
        e.preventDefault();
        const action = form.dataset.action;
        const file = form.querySelector("input[type=file]").files[0];
        if (!file) return alert("Please upload a file.");

        const spinner = document.getElementById(`${action}-spinner`);
        const outputDiv = document.getElementById(`${action}-output`);
        spinner.style.display = "block";
        outputDiv.innerHTML = "";

        const formData = new FormData();
        formData.append("text_file", file);
        formData.append("action", action);

        const response = await fetch("/stream", { method: "POST", body: formData });
        if (!response.ok || !response.body) {
          outputDiv.textContent = "‚ùå Error: Unable to stream response.";
          spinner.style.display = "none";
          return;
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value, { stream: true });
          outputDiv.innerHTML += chunk;
          MathJax.typesetPromise([outputDiv]);
        }

        spinner.style.display = "none";
        outputDiv.innerHTML += "<br><strong>‚úÖ Done!</strong>";
        MathJax.typesetPromise([outputDiv]);
      });
    });

    // --- Custom Prompt Handler ---
    document.getElementById("custom-btn").addEventListener("click", async () => {
      const prompt = document.getElementById("custom-prompt").value.trim();
      const file = document.getElementById("custom-file").files[0];
      if (!prompt && !file) return alert("Enter a prompt or upload a file.");

      const spinner = document.getElementById("custom-spinner");
      const outputDiv = document.getElementById("custom-output");
      spinner.style.display = "block";
      outputDiv.innerHTML = "";

      const formData = new FormData();
      if (file) formData.append("text_file", file);
      formData.append("action", "custom");
      formData.append("custom_prompt", prompt);

      const response = await fetch("/stream", { method: "POST", body: formData });
      const reader = response.body.getReader();
      const decoder = new TextDecoder();

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        outputDiv.innerHTML += decoder.decode(value);
        MathJax.typesetPromise([outputDiv]);
      }

      spinner.style.display = "none";
      outputDiv.innerHTML += "<br><strong>‚úÖ Done!</strong>";
      MathJax.typesetPromise([outputDiv]);
    });
  </script>
</body>
</html>
